#!/bin/bash
set -eao pipefail

# ------------------------------------------------------------------------------
# Script to add sourcing lines for zsh hook files to corresponding z* files
# Hook files in ~/.config/zsh/hooks/ drive the z* file names
# ------------------------------------------------------------------------------

__util_prepend_line() {
    local line="$1"
    local file="$2"

    if [[ -f "$file" ]] && awk -v needle="$line" 'index($0, needle) { found=1; exit } END { exit !found }' "$file"; then
        echo "  âœ“ Sourcing line already present in $file :: $line"
        return 0
    fi

    echo "  + Prepending sourcing line to $file :: $line"
    echo "$line" | cat - "$file" > "$file.tmp"
    mv "$file.tmp" "$file"
}

# ------------------------------------------------------------------------------

ZSH_HOOKS_DIR="$HOME/.config/zsh/hooks"

# Check if hooks directory exists
if [[ ! -d "$ZSH_HOOKS_DIR" ]]; then
    echo "Error: Hooks directory $ZSH_HOOKS_DIR does not exist"
    exit 1
fi

# ------------------------------------------------------------------------------

main() {
    # ensure that all hooks are sourced in the .zshrc file
    for hook_path in "$ZSH_HOOKS_DIR/"*; do
        local hook_file_name=$(basename "$hook_path")
        echo "Processing hook file: $hook_path ($hook_file_name)"

        local into_file="$HOME/.$hook_file_name"
        local hook_path_ref="\$HOME/.config/zsh/hooks/$hook_file_name"

        local hook_line="[[ -s \"$hook_path_ref\" ]] && source \"$hook_path_ref\""
        __util_prepend_line "$hook_line" "$into_file"
    done

    echo ""
    echo "Hooks initialized successfully!"
}

# ------------------------------------------------------------------------------

main
