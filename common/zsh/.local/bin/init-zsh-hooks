#!/bin/bash
set -eo pipefail

# Script to add sourcing lines for zsh hook files to corresponding z* files
# Hook files in ~/.config/zsh/hooks/*.d/ drive the z* file names

__util_prepend_line() {
    local line="$1"
    local file="$2"

    if [[ -f "$file" ]] && grep -qF "$line" "$file" 2>/dev/null; then
        echo "  âœ“ Sourcing line already present in $file"
        return 0
    fi

    echo "  + Prepending sourcing line to $file"
    local tmp_file
    tmp_file=$(mktemp --tmpdir="$(dirname "$file")" "$(basename "$file").tmp.XXXXXX")
    echo "$line" > "$tmp_file"
    [[ -f "$file" ]] && cat "$file" >> "$tmp_file"
    mv "$tmp_file" "$file"
}

main() {
    local zsh_hooks_dir="$HOME/.config/zsh/hooks"
    local hook_loader_path="\$HOME/.config/zsh/hooks/_loader.zsh"

    if [[ ! -d "$zsh_hooks_dir" ]]; then
        echo "Error: Hooks directory $zsh_hooks_dir does not exist" >&2
        exit 1
    fi

    # Enable nullglob so unmatched globs don't produce literal strings
    shopt -s nullglob
    trap 'shopt -u nullglob' EXIT

    local hook_dirs=("$zsh_hooks_dir"/*.d)

    if [[ ${#hook_dirs[@]} -eq 0 ]]; then
        echo "No .d hook directories found in $zsh_hooks_dir"
        return 0
    fi

    for hook_dir_path in "${hook_dirs[@]}"; do
        [[ ! -d "$hook_dir_path" ]] && continue

        local hook_dir_name
        hook_dir_name=$(basename "$hook_dir_path" .d)
        local into_file="$HOME/.$hook_dir_name"
        local hook_dir_ref="\$HOME/.config/zsh/hooks/$hook_dir_name.d"
        local hook_line="[[ -s $hook_loader_path ]] && HOOK_DIR=\"$hook_dir_ref\" source \"$hook_loader_path\";"

        echo "Processing hook directory: $hook_dir_name.d ($hook_dir_ref)"
        __util_prepend_line "$hook_line" "$into_file"
    done

    echo ""
    echo "Hooks initialized successfully!"
}

main
